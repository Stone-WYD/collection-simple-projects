<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>巡检人员同步系统</title>
		<!-- 依 赖 样 式 -->
		<link rel="stylesheet" href="component/pear/css/pear.css" />
		<!-- 加 载 样 式 -->
		<link rel="stylesheet" href="admin/css/loader.css" />
		<!-- 布 局 样 式 -->
		<link rel="stylesheet" href="admin/css/admin.css" />
	</head>
	<!-- 结 构 代 码 -->
	<body class="layui-layout-body pear-admin">
		<!-- 布 局 框 架 -->
		<div class="layui-layout layui-layout-admin">
			<!-- 顶 部 样 式 -->
			<div class="layui-header">
				<!-- 菜 单 顶 部 -->
				<div class="layui-logo">
					<!-- 图 标 -->
					<img class="logo">
					<!-- 标 题 -->
					<span class="title"></span>
				</div>
				<!-- 顶 部 左 侧 功 能 -->
				<ul class="layui-nav layui-layout-left">
					<li class="collapse layui-nav-item"><a href="#" class="layui-icon layui-icon-shrink-right"></a></li>
					<li class="refresh layui-nav-item"><a href="#" class="layui-icon layui-icon-refresh-1" loading = 600></a></li>
				</ul>
				<!-- 多 系 统 菜 单 -->
				<div id="control" class="layui-layout-control"></div>
				<!-- 顶 部 右 侧 菜 单 -->
				<ul class="layui-nav layui-layout-right">
					
					<li class="layui-nav-item layui-hide-xs" style="color: black;">管理员</li>
					<li class="layui-nav-item user">
						<!-- 头 像 -->
						<a class="layui-icon layui-icon-username" href="javascript:;"></a>
						<!-- 功 能 菜 单 -->
						<dl class="layui-nav-child">
							
							<dd><a href="javascript:void(0);" class="logout">注销登录</a></dd>
						</dl>
					</li>
					<!-- 主 题 配 置 -->
					<li class="layui-nav-item setting"><a href="#" class="layui-icon layui-icon-more-vertical"></a></li>
				</ul>
			</div>
			<!-- 侧 边 区 域 -->
			<div class="layui-side layui-bg-black">
				<!-- 菜 单 顶 部 -->
				<div class="layui-logo">
					<!-- 图 标 -->
					<img class="logo">
					<!-- 标 题 -->
					<span class="title"></span>
				</div>
				<!-- 菜 单 内 容 -->
				<div class="layui-side-scroll">
					<div id="sideMenu"></div>
				</div>
			</div>
			<!-- 视 图 页 面 -->
			<div class="layui-body">
				<!-- 内 容 页 面 -->
				<div id="content"></div>
			</div>
			<!-- 页脚 -->
			<div class="layui-footer layui-text">
				<span class="left">
					Released under the MIT license.
				</span>
				<span class="center"></span>
				<span class="right">
					Copyright © 2021-2022 pearadmin.com
				</span>
			</div>
			<!-- 遮 盖 层 -->
			<div class="pear-cover"></div>
			<!-- 加 载 动 画 -->
			<div class="loader-main">
				<!-- 动 画 对 象 -->
				<div class="loader"></div>
			</div>
		</div>
		<!-- 移 动 端 便 捷 操 作 -->
		<div class="pear-collapsed-pe collapse">
			<a href="#" class="layui-icon layui-icon-shrink-right"></a>
		</div>
		<!-- 依 赖 脚 本 -->
		<script src="component/js/configs.js"></script>
		<script src="component/layui/layui.js"></script>
		<script src="component/pear/pear.js"></script>
		<!-- 框 架 初 始 化 -->
		<script>

			var $;

			layui.use(['admin','jquery','popup','drawer'], function() {
				 $ = layui.jquery;
				var admin = layui.admin;
				var popup = layui.popup;
				
				admin.setConfigType("yml");
				admin.setConfigPath("config/pear.config.yml");
				
				admin.render();
				
				// 登出逻辑 
				admin.logout(function(){

					loginOut();

					popup.success("注销成功",function(){



						location.href = "index.html";
					})
					// 注销逻辑 返回 true / false
					return true;
				})
				
				// 消息点击回调
				admin.message(function(id, title, context, form) {});
				
				
				//iframe[id='" + id + "']
					//  console.log((document.getElementById('sbzt')));
					//  console.log("allTabs ",$("iframe[id='sbzt']"));
				
				
				/*
					let intervalID = setInterval(function() {
								//console.log("这个消息每秒打印一次");
						
								console.log((document.getElementById('sbzt').contentWindow.testabc()));
								
								
							//	console.log($("iframe[id='sbzt']").contentWindow.testabc());
								
								console.log(document.getElementsByTagName('iframe'));
								
								
								//console.log(document.getElementsByTagName('iframe')['sbzt'].testabc());
								
								
								///console.log(window.frames["sbzt"]);//window.frames["view_sjzl"]
								
								//$("iframe[id='sbzt']").testabc();
								//document.getElementById('sbzt').testabc();
						
						
							}, 3000); // 
							
							*/
							
							//openSocket();
							
							//checkWebSocket();
				
			})
			
			
			function getMainInfo()
			{
			
				var token = storage.getItem("gas_access_token");	
				
				$.ajax({
						type: "POST", //向后台请求的方式，有post，get两种方法
						dataType:"json",
					
						headers:{
							"X-ACCESS-TOKEN":token,
											
						},
						url: baseUrl+"/api/v1/getMainInfo", 
						
						data:({
						
							
						}),
						cache: false, //缓存是否打开
						success: function(datas) { //请求的返回成功的方法
						
						console.log(datas);
							if (datas.code == "0") {
								
												//var allcount = datas.dscount + datas.dxcount;
												
											//	var freecount = datas.dssycount + datas.dxsycount;
												
											//	$("#allcount").html(""+allcount);
											
												
												
												
								
							} else {
								//alert("加载失败");
								//layer.msg(datas.msg);
							}
						},
								error: function(xhr, status, error) {
										
											//layer.msg("执行失败");
								}
										
					});	
			}
			
			
			
			
			//监听单个事件
				window.addEventListener('message', function (msg) {
					//console.log(msg);
			
					if(msg.data.type == "timeout")//给水弹出界面
					{
			
			
						
						layer.msg('登陆超时',{'time':1000}, function () {
							window.location = 'index.html';
						});
			
			
			
					}
			
				})
				
				
				
				
				
				var socket;
				var isConnect = false;
				
				
				function openSocket() {
					console.log("websocket 执行打开");
				
				
					if(typeof(WebSocket) == "undefined") {
						console.log("您的浏览器不支持WebSocket");
					}else{
				
						var storage = window.localStorage;
				
				
				
					//	var ibmsToken = storage.getItem("access_token");
				
						console.log("您的浏览器支持WebSocket");
						//实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
						//等同于socket = new WebSocket("ws://localhost:8888/xxxx/im/25");
						//var socketUrl= "ws://${pageContext.request.serverName}:${pageContext.request.serverPort}${pageContext.request.contextPath}/ws/monitoring/2";
				
						
				
						console.log(wsBaseUrl);
						if(socket!=null){
							socket.close();
							socket=null;
						}
						socket = new WebSocket(wsBaseUrl+"?type=web");
						//打开事件
						socket.onopen = function() {
							console.log("websocket已打开");
							//socket.send("这是来自客户端的消息" + location.href + new Date());
				
							isConnect = true;
				
							//	let object = new Object();
							//	object.type = 1;
							//	object.cmdType = 0;
				
				
							//	socket.send(JSON.stringify(object));
				
				
						};
						//获得消息事件
						socket.onmessage = function(msg) {
							console.log(msg.data);
							if(msg.data!=null)
							{
								let object = JSON.parse(msg.data);
				
				
								if(object != null)
								{
									if(object.cmd != undefined)
									{
										if(object.cmd == 1)// 状态更新
										{
											if(document.getElementById('record') != undefined)
											{
												document.getElementById('record').contentWindow.updateServerMsg(object);
											}
											//document.getElementById('sbzt').testabc();
											/*
											if(window.frames["view_sjzl"] != undefined)
											{
												window.frames["view_sjzl"].updateStatus(object);
				
											}
											if(window.frames["view_yckz"] != undefined)
											{
												window.frames["view_yckz"].updateStatus(object);
				
											}
											*/
				
										}else if(object.cmd == 2)
										{
				
				
										}
				
				
									}
								}
				
				
							}
							//发现消息进入    开始处理前端触发逻辑
						};
						//关闭事件
						socket.onclose = function() {
							console.log("websocket已关闭");
				
							isConnect = false;
				
				
				
				
						};
						//发生了错误事件
						socket.onerror = function() {
							console.log("websocket发生了错误");
				
							console.log(wsBaseUrl);
				
				
						}
					}
				}
				function sendMessage() {
					if(typeof(WebSocket) == "undefined") {
						console.log("您的浏览器不支持WebSocket");
					}else {
						console.log("您的浏览器支持WebSocket");
						//console.log('{"toUserId":"'+$("#toUserId").val()+'","contentText":"'+$("#contentText").val()+'"}');
						//socket.send('{"toUserId":"'+$("#toUserId").val()+'","contentText":"'+$("#contentText").val()+'"}');
					}
				}
				
				var checkCount = 0;
				function checkWebSocket()
				{
					let intervalID = setInterval(function() {
						//console.log("这个消息每秒打印一次");
				
						checkCount++;
						if(checkCount>10)
						{
							checkCount = 0;
				
							if(!isConnect)
							{
								openSocket();
							}else {
								console.log("发送心跳");
				
								socket.send('{"cmd":"0","msg":""}');
							}
						}
				
				
					}, 1000); // 1000 毫秒 = 1 秒
				}



			function loginOut()
			{

				let token = storage.getItem("gas_access_token");

				console.log("loginout token ",token);

				$.ajax({
					type: "POST", //向后台请求的方式，有post，get两种方法
					dataType:"json",

					headers:{
						"X-ACCESS-TOKEN":token,

					},
					url: baseUrl+"/api/v1/loginOut",

					data:({


					}),
					cache: false, //缓存是否打开
					success: function(datas) { //请求的返回成功的方法

						console.log(datas);
						if (datas.code == "0") {




						} else {

						}
					},
					error: function(xhr, status, error) {

						//layer.msg("执行失败");
					}

				});
			}
			
			
		</script>		
	</body>
</html>
